<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ESHIM ID Auction</title>
  <style>
    * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { background: #101010; color: #fff; display: flex; justify-content: center; padding: 2rem; }
    .auction-card {
      background: #1c1c1c;
      padding: 2rem;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.05);
    }
    h1 { font-size: 1.8rem; color: #38bdf8; margin-bottom: 0.5rem; }
    .reward { font-size: 1.1rem; color: #86efac; margin-bottom: 1rem; }
    input, button {
      width: 100%; padding: 0.75rem; font-size: 1rem;
      border-radius: 8px; border: none; outline: none;
    }
    input { background: #222; color: #fff; margin-bottom: 1rem; }
    button {
      background: #10b981; color: #fff; font-weight: bold;
      cursor: pointer; transition: 0.3s;
    }
    button:hover { background: #059669; }
    .info { margin-bottom: 1rem; }
    .bid-list {
      background: #151515; padding: 1rem;
      border-radius: 8px; margin-top: 1rem;
      max-height: 160px; overflow-y: auto;
    }
    .bid-item {
      border-bottom: 1px solid #333; padding: 0.4rem 0;
    }
    .ended { background: #ef4444; }
  </style>
</head>
<body>
  <div class="auction-card">
    <h1>ESHIM ID Auction üî•</h1>
    <div class="reward">üèÜ Winner gets: Custom NFT badge</div>
    <div class="info">
      <strong>Current Auction:</strong> <span id="activeEshimId">Waiting...</span><br/>
      <strong>Top Bid:</strong> <span id="topBid">0</span> Eshim<br/>
      <strong>Top Bidder (ESHIM ID):</strong> <span id="topUser">N/A</span><br/>
      <strong>Time Left:</strong> <span id="timer">Waiting...</span>
    </div>
    <input type="text" id="eshimId" placeholder="Loading..." readonly />
    <input type="number" id="bidAmount" placeholder="Your bid amount in Eshim" disabled />
    <button id="bidBtn" disabled>Place Bid</button>
    <div class="bid-list" id="bidList"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, doc, onSnapshot, updateDoc, getDoc, collection, query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD0BvBkEdHI2TCt1MH4I8VFAteTUkMw_PE",
      authDomain: "eshim-coin.firebaseapp.com",
      projectId: "eshim-coin",
      storageBucket: "eshim-coin.firebasestorage.app",
      messagingSenderId: "1027852914663",
      appId: "1:1027852914663:web:9381d871eedca60896f742",
      measurementId: "G-M1K1X7QVTS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const topBidEl = document.getElementById("topBid");
    const topUserEl = document.getElementById("topUser");
    const timerEl = document.getElementById("timer");
    const bidBtn = document.getElementById("bidBtn");
    const bidListEl = document.getElementById("bidList");
    const activeEshimEl = document.getElementById("activeEshimId");
    const accID = localStorage.getItem("accID");
    const accIdInput = document.getElementById("eshimId");

    if (!accID) {
      alert("You are not logged in");
      bidBtn.disabled = true;
      document.getElementById("bidAmount").disabled = true;
    } else {
      accIdInput.value = accID;
    }

    let bids = [];
    let countdown = null;

    function updateTimerUI(timeLeft) {
      timerEl.textContent = timeLeft > 0 ? `${timeLeft}s` : "Ended";
    }

    function startCountdown(startedAt, duration) {
      const end = startedAt + duration * 1000;

      clearInterval(countdown);
      countdown = setInterval(async () => {
        const now = Date.now();
        const timeLeft = Math.max(0, Math.floor((end - now) / 1000));
        updateTimerUI(timeLeft);

        if (timeLeft <= 0) {
          clearInterval(countdown);
          bidBtn.disabled = true;
          bidBtn.classList.add("ended");
          bidBtn.textContent = "Auction Ended";
          await handleAuctionEnd();
        }
      }, 1000);
    }

    async function handleAuctionEnd() {
      const snap = await getDoc(doc(db, "auction", "current"));
      const data = snap.data();
      if (!data?.topUser || !data?.eshimId) return;
      const q = query(collection(db, "users"), where("accID", "==", data.topUser));
      const res = await getDocs(q);
      if (res.empty) return;
      const winnerDoc = res.docs[0];
      await updateDoc(winnerDoc.ref, { accID: data.eshimId });
      alert(`üéâ Auction ended. ${data.topUser} is now assigned ESHIM ID ${data.eshimId}`);
    }

    const auctionRef = doc(db, "auction", "current");
    onSnapshot(auctionRef, (snap) => {
      const data = snap.data();

      if (!data || !data.isActive) {
        activeEshimEl.textContent = "No active auction";
        bidBtn.disabled = true;
        document.getElementById("bidAmount").disabled = true;
        timerEl.textContent = "Waiting...";
        return;
      }

      const { eshimId, topBid, topUser, startedAt, duration } = data;

      activeEshimEl.textContent = eshimId;
      topBidEl.textContent = topBid || 0;
      topUserEl.textContent = topUser || "N/A";
      bidBtn.disabled = false;
      document.getElementById("bidAmount").disabled = false;
      bidBtn.textContent = "Place Bid";

      const startTime = startedAt?.seconds ? startedAt.seconds * 1000 : Date.now();
      startCountdown(startTime, duration || 60);
    });

    bidBtn.addEventListener("click", async () => {
      const amount = parseInt(document.getElementById("bidAmount").value);
      if (!accID || isNaN(amount) || amount <= 0) {
        alert("Invalid bid or accID not detected.");
        return;
      }

      const snap = await getDoc(auctionRef);
      const current = snap.data();
      if (amount <= (current?.topBid || 0)) {
        alert("Your bid must be higher than the current top bid!");
        return;
      }

      await updateDoc(auctionRef, {
        topBid: amount,
        topUser: accID
      });

      bids.push({ userId: accID, amount, time: new Date().toLocaleTimeString() });
      updateBidList();
      document.getElementById("bidAmount").value = "";
    });

    function updateBidList() {
      bidListEl.innerHTML = "";
      bids.slice().reverse().forEach(bid => {
        const el = document.createElement("div");
        el.className = "bid-item";
        el.innerText = `üü¢ ${bid.userId} ‚Üí ${bid.amount} Eshim @ ${bid.time}`;
        bidListEl.appendChild(el);
      });
    }
  </script>
</body>
</html>
